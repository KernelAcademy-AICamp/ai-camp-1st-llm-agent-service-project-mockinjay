# CareGuide Client

A Flask-based web client for the CareGuide Healthcare Chatbot, built on top of the Parlant REST API.

## Features

- ğŸ” **Hybrid Search**: Combines keyword matching and semantic similarity search
- ğŸ“š **Multi-Source Integration**: QA database, local papers, medical data, and real-time PubMed search
- ğŸ‘¤ **User Profiles**: Customized information delivery for researchers, patients, and general users
- ğŸ’¬ **Real-time Chat**: Interactive chat interface with automatic polling for instant message updates
- âš¡ **Non-blocking Architecture**: Messages appear as soon as they're generated by the AI
- ğŸ¥ **Medical Safety**: Built-in emergency detection and medical disclaimers

## Architecture

```
client/
â”œâ”€â”€ app.py                  # Flask application
â”œâ”€â”€ parlant_client.py       # Parlant REST API client
â”œâ”€â”€ templates/              # HTML templates
â”‚   â”œâ”€â”€ base.html
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ chat.html
â”œâ”€â”€ static/                 # Static assets
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ style.css
â”‚   â””â”€â”€ js/
â”‚       â””â”€â”€ chat.js
â”œâ”€â”€ requirements.txt        # Python dependencies
â”œâ”€â”€ .env.example           # Environment configuration template
â””â”€â”€ README.md              # This file
```

## Prerequisites

- Python 3.8+
- Access to a running Parlant server
- CareGuide agent configured in Parlant (see [healthcare_v2_en.py](../parlant/healthcare_v2_en.py))

## Installation

### 1. Clone the repository

```bash
cd /path/to/ai-camp-1st-llm-agent-service-project-mockinjay
```

### 2. Set up virtual environment

```bash
cd client
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

### 3. Install dependencies

```bash
pip install -r requirements.txt
```

### 4. Configure environment

```bash
cp .env.example .env
```

Edit `.env` and configure:

```bash
# Flask Configuration
FLASK_SECRET_KEY=your-secret-key-here
FLASK_PORT=8000
FLASK_DEBUG=true

# Parlant Server
PARLANT_SERVER=http://localhost:8800
PARLANT_AGENT_NAME=CareGuide_v2

# CareGuide Settings
CARE_GUIDE_DEFAULT_PROFILE=general
```

## Running the Application

### Development Mode

```bash
python app.py
```

The application will start on [http://localhost:8000](http://localhost:8000)

### Production Mode

```bash
gunicorn -w 4 -b 0.0.0.0:8000 app:app
```

## Usage

### 1. Access the Application

Navigate to [http://localhost:8000](http://localhost:8000) in your web browser.

### 2. Select User Profile

Click the "í”„ë¡œí•„ ì„¤ì •" button to choose your user type:

- **ì—°êµ¬ì/ì „ë¬¸ê°€ (Researcher/Expert)**
  - Academic language and technical terminology
  - Up to 10 search results per source
  - Detailed paper abstracts, DOIs, and citations

- **ì§ˆí™˜ì/ê²½í—˜ì (Patient/Experience Holder)**
  - Practical and applicable information
  - Up to 5 search results per source
  - Focus on treatments and self-care

- **ì¼ë°˜ì¸/ì´ˆì‹¬ì (General Public/Novice)**
  - Simple explanations in plain language
  - Up to 3 search results per source
  - Focus on basic concept understanding

### 3. Ask Questions

Type your medical questions in Korean. The chatbot will:
- Search across multiple data sources
- Provide profile-appropriate responses
- Include relevant research papers and citations
- Add medical disclaimers automatically

### 4. Session Management

- **ëŒ€í™” ì´ˆê¸°í™” (Reset Session)**: Clear conversation history and start fresh

## API Endpoints

### Chat Endpoints

#### `POST /api/message`

Send a message to the chatbot (non-blocking).

**Request:**
```json
{
  "message": "ë‹¹ë‡¨ë³‘ì˜ ì¦ìƒì€ ë¬´ì—‡ì¸ê°€ìš”?"
}
```

**Response:**
```json
{
  "status": "sent",
  "message": "ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.",
  "session_id": "session_abc123"
}
```

#### `GET /api/poll`

Poll for new messages from the assistant (automatic - called by frontend).

**Query Parameters:**
- `wait`: Wait time in seconds (default: 10, max: 30)

**Response:**
```json
{
  "status": "ok",
  "messages": ["ë‹¹ë‡¨ë³‘ì˜ ì£¼ìš” ì¦ìƒì€..."],
  "papers": [
    {
      "title": "Diabetes Mellitus: Symptoms and Treatment",
      "authors": ["Smith, J.", "Johnson, K."],
      "journal": "Medical Journal",
      "pub_date": "2024-01",
      "pmid": "12345678",
      "doi": "10.1234/example",
      "url": "https://pubmed.ncbi.nlm.nih.gov/12345678/"
    }
  ],
  "has_more": false
}
```

#### `POST /api/profile`

Set user profile.

**Request:**
```json
{
  "profile_type": "researcher"
}
```

**Response:**
```json
{
  "status": "success",
  "profile": "researcher"
}
```

#### `POST /api/session/reset`

Reset the chat session.

**Response:**
```json
{
  "status": "success",
  "message": "ì„¸ì…˜ì´ ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

### Health Check

#### `GET /health`

Check application and Parlant server health.

**Response:**
```json
{
  "status": "healthy",
  "parlant": "connected"
}
```

## Parlant Client API

The `parlant_client.py` module provides a comprehensive Python client for the Parlant REST API.

### Example Usage

```python
from parlant_client import ParlantClient, ParlantConfig

# Create client
config = ParlantConfig(base_url="http://localhost:8800")
client = ParlantClient(config)

# List agents
agents = client.list_agents()

# Create session
session = client.create_session(
    agent_id="agent_123",
    metadata={"careguide_profile": "researcher"},
    allow_greeting=False
)

# Send message
client.post_customer_message(
    session_id=session["id"],
    message="What are the symptoms of diabetes?"
)

# Wait for response
messages, offset = client.wait_for_assistant_response(
    session_id=session["id"],
    last_offset=0
)
```

### Supported Operations

The client supports all Parlant REST API operations:

- **Agents**: create, read, update, delete, list
- **Customers**: create, read, update, delete, list
- **Tags**: create, read, update, delete, list
- **Sessions**: create, read, update, delete, list
- **Events**: create, list, delete
- **Helper methods**: wait_for_assistant_response, post_customer_message

See [parlant_client.py](parlant_client.py) for full documentation.

## Configuration Options

### Flask Settings

| Variable | Default | Description |
|----------|---------|-------------|
| `FLASK_SECRET_KEY` | `careguide-secret-key-2024` | Secret key for session management |
| `FLASK_PORT` | `8000` | Port to run the Flask server |
| `FLASK_DEBUG` | `true` | Enable debug mode |

### Parlant Settings

| Variable | Default | Description |
|----------|---------|-------------|
| `PARLANT_SERVER` | `http://localhost:8800` | Parlant server URL |
| `PARLANT_AGENT_ID` | (auto-discover) | Agent ID (optional) |
| `PARLANT_AGENT_NAME` | `CareGuide_v2` | Agent name for auto-discovery |
| `PARLANT_HTTP_TIMEOUT` | `60` | HTTP request timeout (seconds) |

### CareGuide Settings

| Variable | Default | Description |
|----------|---------|-------------|
| `CARE_GUIDE_DEFAULT_PROFILE` | `general` | Default user profile |

## Troubleshooting

### Cannot connect to Parlant server

**Problem**: `Connection refused` or `502 Bad Gateway` errors

**Solutions**:
1. Ensure Parlant server is running: `curl http://localhost:8800/agents`
2. Check `PARLANT_SERVER` in `.env` matches your server URL
3. Verify firewall settings allow connections

### Agent not found

**Problem**: `No Parlant agent named 'CareGuide_v2' was found`

**Solutions**:
1. Run the healthcare_v2_en.py script to create the agent:
   ```bash
   cd ../parlant
   python healthcare_v2_en.py
   ```
2. Set `PARLANT_AGENT_ID` in `.env` to bypass auto-discovery
3. Check agent name with: `curl http://localhost:8800/agents`

### Session errors

**Problem**: Messages not showing or session errors

**Solutions**:
1. Click "ëŒ€í™” ì´ˆê¸°í™”" to reset the session
2. Clear browser cookies and refresh
3. Check browser console for JavaScript errors

### Slow responses

**Problem**: Long wait times for chatbot responses

**Solutions**:
1. Increase `PARLANT_HTTP_TIMEOUT` in `.env`
2. Check Parlant server logs for processing delays
3. Verify database and search engine connectivity

## Development

### Project Structure

- **app.py**: Flask application with routes and business logic
- **parlant_client.py**: Reusable Parlant API client
- **templates/**: Jinja2 HTML templates
- **static/**: CSS and JavaScript files

### Adding New Features

1. **Backend**: Add routes to [app.py](app.py)
2. **Frontend**: Update templates in [templates/](templates/)
3. **Styling**: Modify [static/css/style.css](static/css/style.css)
4. **Behavior**: Update [static/js/chat.js](static/js/chat.js)

### Testing

```bash
# Test health endpoint
curl http://localhost:8000/health

# Test message endpoint
curl -X POST http://localhost:8000/api/message \
  -H "Content-Type: application/json" \
  -d '{"message": "ë‹¹ë‡¨ë³‘ì˜ ì¦ìƒì€?"}'
```

## Security Considerations

- Change `FLASK_SECRET_KEY` in production
- Use HTTPS in production environments
- Implement rate limiting for API endpoints
- Sanitize user inputs (already handled by Parlant)
- Never expose `.env` file in version control

## License

This project is part of the AI Camp 1st LLM Agent Service Project.

## Related Documentation

- [Parlant REST API Reference](https://docs.parlant.io/rest-api)
- [healthcare_v2_en.py](../parlant/healthcare_v2_en.py) - Main CareGuide agent
- [Hybrid Search Engine](../search/hybrid_search.py) - Search implementation
- [POLLING_UPDATE.md](POLLING_UPDATE.md) - Real-time polling architecture

## Support

For issues or questions:
1. Check the [troubleshooting section](#troubleshooting)
2. Review Parlant server logs
3. Check browser console for client-side errors
4. Open an issue in the project repository
