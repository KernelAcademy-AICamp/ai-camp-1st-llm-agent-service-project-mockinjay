MyPage API - 3-Layer Architecture
==================================

┌─────────────────────────────────────────────────────────────────────┐
│                          Client (Frontend)                          │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    LAYER 1: Router (mypage.py)                      │
│                              277 lines                              │
├─────────────────────────────────────────────────────────────────────┤
│  Endpoints:                                                         │
│  • GET/PUT  /profile          → ProfileService                     │
│  • GET/PUT  /health-profile   → HealthService                      │
│  • GET/PUT  /preferences      → PreferencesService                 │
│  • GET/POST/DELETE /bookmarks → BookmarkService                    │
│  • GET /posts                 → DB Direct                           │
│  • GET /level                 → PointsService                       │
│  • GET /points                → PointsService                       │
│  • GET /points/history        → PointsService                       │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   LAYER 2: Service Layer (services/mypage/)         │
│                              1,003 lines                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐ │
│  │ ProfileService   │  │  HealthService   │  │PreferencesService│ │
│  │   (145 lines)    │  │   (137 lines)    │  │   (123 lines)    │ │
│  ├──────────────────┤  ├──────────────────┤  ├──────────────────┤ │
│  │• get_profile()   │  │• get_health_    │  │• get_preferences│ │
│  │• update_profile()│  │  profile()       │  │• update_        │ │
│  │                  │  │• update_health_  │  │  preferences()   │ │
│  │                  │  │  profile()       │  │                  │ │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘ │
│                                                                     │
│  ┌──────────────────┐  ┌──────────────────────────────────────┐   │
│  │ BookmarkService  │  │      PointsService (354 lines)       │   │
│  │   (181 lines)    │  ├──────────────────────────────────────┤   │
│  ├──────────────────┤  │• get_level()                         │   │
│  │• get_bookmarks() │  │• get_points()                        │   │
│  │• add_bookmark()  │  │• get_history()                       │   │
│  │• remove_        │  │• add_points() [INTERNAL]              │   │
│  │  bookmark()      │  │• calculate_level_from_xp()           │   │
│  └──────────────────┘  └──────────────────────────────────────┘   │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │             Utils (42 lines)                                 │  │
│  │  • serialize_object_id()  • serialize_datetime()            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    LAYER 3: Database (MongoDB)                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐  ┌─────────────┐  ┌──────────────────┐          │
│  │    users     │  │health_      │  │user_preferences  │          │
│  │              │  │profiles     │  │                  │          │
│  └──────────────┘  └─────────────┘  └──────────────────┘          │
│                                                                     │
│  ┌──────────────┐  ┌─────────────┐  ┌──────────────┐  ┌────────┐ │
│  │  bookmarks   │  │user_levels  │  │user_points   │  │ posts  │ │
│  └──────────────┘  └─────────────┘  └──────────────┘  └────────┘ │
│                                                                     │
│  ┌──────────────┐  ┌─────────────────────────────────────────┐    │
│  │user_badges   │  │    points_history                       │    │
│  └──────────────┘  └─────────────────────────────────────────┘    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘


Data Model Layer (models/mypage.py - 285 lines)
================================================

Request Models:                    Response Models:
────────────────                   ─────────────────
• UserProfileUpdateRequest         • UserProfileResponse
• HealthProfileUpdateRequest       • HealthProfileResponse
• UserPreferencesUpdateRequest     • UserPreferencesResponse
• BookmarkCreateRequest            • BookmarkResponse
                                   • UserLevelResponse
                                   • PointsDataResponse
                                   • PointsHistoryResponse
                                   • PointsHistoryItemResponse


File Organization
=================

backend/app/
├── api/
│   └── mypage.py ...................... 277 lines (Routing Layer)
│
├── models/
│   └── mypage.py ...................... 285 lines (Data Models)
│
└── services/
    └── mypage/
        ├── __init__.py ................ 21 lines  (Exports)
        ├── profile_service.py ......... 145 lines (Profile Logic)
        ├── health_service.py .......... 137 lines (Health Logic)
        ├── preferences_service.py ..... 123 lines (Preferences Logic)
        ├── bookmark_service.py ........ 181 lines (Bookmark Logic)
        ├── points_service.py .......... 354 lines (Points/Level Logic)
        └── utils.py ................... 42 lines  (Utilities)

Total: 1,565 lines across 9 files
Original: 1,268 lines in 1 file
Router Reduction: 78% (1,268 → 277 lines)


Request Flow Example
====================

1. Client sends: GET /api/mypage/profile
   │
   ▼
2. Router (mypage.py):
   │  - Authenticates user (get_current_user dependency)
   │  - Extracts user_id from token
   │  - Calls ProfileService.get_profile(user_id, current_user)
   │
   ▼
3. ProfileService (profile_service.py):
   │  - Fetches user data from database
   │  - Transforms data (adds aliases for frontend compatibility)
   │  - Handles errors and logging
   │  - Returns formatted profile data
   │
   ▼
4. Router validates response with UserProfileResponse model
   │
   ▼
5. Client receives JSON response


Key Design Patterns
===================

1. Dependency Injection
   - Services initialized once in router
   - Database connections injected into services

2. Single Responsibility Principle
   - Each service handles one domain
   - Router only handles HTTP concerns

3. DRY (Don't Repeat Yourself)
   - Common utilities extracted
   - Reusable service methods

4. Error Handling
   - Consistent HTTPException usage
   - Proper logging throughout

5. Data Validation
   - Pydantic models for type safety
   - Request/Response validation

